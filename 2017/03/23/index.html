<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用一副漫画解释AngularJS中的Promise · DongSuo-徐晓飞的个人博客</title><meta name="description" content="用一副漫画解释AngularJS中的Promise - XuXiaofei/徐晓飞"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/logo.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.islasher.com/atom.xml" title="DongSuo-徐晓飞的个人博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">用一副漫画解释AngularJS中的Promise</h1><div class="post-info">Mar 23, 2017</div><div class="post-content"><h5 id="一个早晨，父亲对孩子说：‘去给我把天气预报搞来，儿砸！’"><a href="#一个早晨，父亲对孩子说：‘去给我把天气预报搞来，儿砸！’" class="headerlink" title="一个早晨，父亲对孩子说：‘去给我把天气预报搞来，儿砸！’"></a>一个早晨，父亲对孩子说：‘去给我把天气预报搞来，儿砸！’</h5><p>每个周日的早晨，父亲都会让他儿子到房子旁边最高的山上用超级望远镜看向地平线来预报当天下午的天气。儿子则向他爸爸承诺他会去山上预报天气。于是，当他出门的时候，他在门口向他爸爸作出了一个承诺。</p>
<p>这个时候，父亲决定，如果是个好天气的话，他就准备一次钓鱼旅行，如果坏天气的话，他就不出去，而且如果儿子没能搞来天气预报，他也不出去。</p>
<p>大概半个小时之后，儿子回来了。一周一周地过去了，各种不一样的情况发生了。</p>
<a id="more"></a>
<h5 id="结果A：成功预报天气！阳光明媚"><a href="#结果A：成功预报天气！阳光明媚" class="headerlink" title="结果A：成功预报天气！阳光明媚:-)"></a>结果A：成功预报天气！阳光明媚:-)</h5><p>儿子成功地预报了天气，天气晴朗，阳光明媚！承诺兑现了（儿子保守了诺言），父亲决定收拾东西准备周日的钓鱼旅行。</p>
<p><img src="http://andyshora.com/img/pages/promise1.png" alt="Promise fulfilled, and weather is good"></p>
<h5 id="结果B：成功预报天气！阴雨连绵"><a href="#结果B：成功预报天气！阴雨连绵" class="headerlink" title="结果B：成功预报天气！阴雨连绵:-("></a>结果B：成功预报天气！阴雨连绵:-(</h5><p>儿子成功地预报了天气，但是看起来阴雨连绵。承诺兑现了，但由于是坏天气，父亲决定哪也不去。</p>
<p><img src="http://andyshora.com/img/pages/promise1.png" alt="Promise fulfilled, and weather is good"></p>
<h5 id="结果C：没能预报天气"><a href="#结果C：没能预报天气" class="headerlink" title="结果C：没能预报天气:-/"></a>结果C：没能预报天气:-/</h5><p>儿子没能预报天气，出问题了；雾太浓导致没法在山顶上看清会有什么天气。儿子走时作出的承诺没能兑现——承诺被拒绝了（rejected）！父亲决定还是不要出去了，没必要冒这个险。</p>
<p><img src="http://andyshora.com/img/pages/promise2.png" alt="Promise rejected"></p>
<h5 id="在代码里看起来是什么样的呢？"><a href="#在代码里看起来是什么样的呢？" class="headerlink" title="在代码里看起来是什么样的呢？"></a>在代码里看起来是什么样的呢？</h5><p>在这个情形中，父亲控制着逻辑，父亲跟儿子打交道，就好像儿子是一个服务一样。</p>
<p>我们已经说明了这个逻辑，父亲让儿子去搞来天气预报，由于儿子不能立刻告诉父亲天气预报，于是父亲在等待的时候先去做别的事情，儿子承诺他会带天气预报回来。父亲得到天气预报后，他要么打包收拾船，要么待在家里。重要的是要记住，孩子去山上预报天气的过程不应该‘阻塞’父亲做其他事情，所以这就是为什么这个情况能够完美地说明承诺的创建以及之后承诺的解决（兑现或拒绝）这一过程。</p>
<h5 id="Controller-FatherCtrl"><a href="#Controller-FatherCtrl" class="headerlink" title="Controller:FatherCtrl"></a>Controller:FatherCtrl</h5><p>这是关于父亲控制这个情形的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// father-controller.js中某个地方的方法</span></div><div class="line"><span class="keyword">var</span> makePromiseWithSon = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">// 这个服务的方法返回一个promise，我们稍后处理那部分</span></div><div class="line">  sonService.getWeather()</div><div class="line">  	<span class="comment">//当儿子回来的时候then()就会被调用</span></div><div class="line">  	.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">      	<span class="comment">//承诺兑现</span></div><div class="line">    	<span class="keyword">if</span>(data.forecast ===<span class="string">'good'</span>)&#123;</div><div class="line">          prepareFishingTrip();</div><div class="line">    	&#125;<span class="keyword">else</span>&#123;</div><div class="line">          prepareSundayRoasterDinner();</div><div class="line">    	&#125;</div><div class="line">  	&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</div><div class="line">      <span class="comment">//承诺被拒绝（没能兑现），可以通过console.log('error',error);把错误信息记录下来</span></div><div class="line">    prepareSundayRoasterDinner();</div><div class="line">  	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Service-SonService"><a href="#Service-SonService" class="headerlink" title="Service:SonService"></a>Service:SonService</h5><p>儿子被用作一个服务，他爬上山顶尝试看清天气。我们假设儿子通过他的望远镜查找即将到来的天气时，类似于使用一个天气API，在某种意义上说它是一个异步操作，他可能得到很多种应答，可能会是一个错误（比如说一个500相应（译者注：内部服务器错误），大雾天气）。</p>
<p>如果承诺兑现了，‘钓鱼天气API’的响应会以｛“forecast”:”good”｝的格式，跟承诺一起被返回。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">app.factory(<span class="string">'SonService'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$http, $q</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            getWeather: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="comment">// $http API基于$q服务暴露出来的deferred/promise APIs</span></div><div class="line">                <span class="comment">// 所以对我们来说他默认返回一个承诺（promise）</span></div><div class="line">                <span class="keyword">return</span> $http.get(<span class="string">'http://fishing-weather-api.com/sunday/afternoon'</span>)</div><div class="line">                    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (<span class="keyword">typeof</span> response.data === <span class="string">'object'</span>) &#123;</div><div class="line">                            <span class="keyword">return</span> response.data;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="comment">// 无效的响应</span></div><div class="line">                            <span class="keyword">return</span> $q.reject(response.data);</div><div class="line">                        &#125;</div><div class="line">                    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">                        <span class="comment">// 什么地方出错了</span></div><div class="line">                        <span class="keyword">return</span> $q.reject(response.data);</div><div class="line">                    &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>这个类比说明了父亲对儿子请求天气预报的异步性质。当儿子出门的时候，父亲不想带着期待在门口等着，因为他还有其他的事情要做。他在门口跟儿子约定了一个承诺，并针对三种可能的情景（好天气/坏天气/没有预报）都作出了决定。儿子离开时立刻给了父亲一个承诺，将在回来时解决或者拒绝它。</p>
<p>儿子是在处理一个异步服务（用望远镜搜索天空/使用一个天气API）来获取数据，但是这一切都被正确地从他老爹那里抽象出来了，他老爹根本不需真正懂这个技术。</p>
<p><em>原文地址：<a href="http://andyshora.com/promises-angularjs-explained-as-cartoon.html" target="_blank" rel="noopener">http://andyshora.com/promises-angularjs-explained-as-cartoon.html</a></em></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/16/" class="prev">上一篇</a><a href="/2016/12/31/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2019 <a href="https://blog.islasher.com">XuXiaofei/徐晓飞</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-110850031-1",'auto');ga('send','pageview');</script></body></html>